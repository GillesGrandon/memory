<!DOCTYPE html>

<html>

<head>
    <link href="memory.css" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <script>
        var nbImg = 16;
        var imgWidth = 10;
        var imgHeight = 10;
        var imgSpacing = 10;
        var tabImgSrc = [];
        var nbCols = 2;
        var nbRows = 2;
        var tabCompareImgSrc = [];
        var tabToggleDivId = [];
        var clickCount = 0;
        var resetTimeout;
        var nbImgFound = 0;
        var isStartTimer = true;


        function initImgSrc() {
            var a = 1
            for (var i = 0; i < nbImg; i++) {
                tabImgSrc[i] = "img/img" + a + ".jpg";
                if ((i + 1) % 2 == 0) a++;
            }
            console.log('tabImgSrc :' + tabImgSrc.length);
        }

        function getRandomImgSrc() {
            var start = Math.floor(Math.random() * tabImgSrc.length)
            return tabImgSrc.splice(start, 1);
        }


        function initImgSize() {
            imgWidth = $('#imgSize').width();
            imgHeight = $('#imgSize').height();
        }


        function initImgPosition() {
            // si un nombre impair
            if (nbImg % 2 != 0) nbImg -= 1;
            var cols = 2;
            var rows = 2;

            while (rows < nbImg) {
                var multi = rows * cols;
                if (multi > nbImg) {
                    rows++;
                    cols = 2;
                }
                if (multi === nbImg && cols >= rows) {
                    nbRows = rows;
                    nbCols = cols
                }
                cols++;
            }
        }

        function displayImg() {

            var left = 0;
            var top = 0;
            var nbImgTmp = nbImg + 1;

            containerSizeString = "width : " + imgWidth + "px; height : " + imgHeight + "px;"
                // placer les images
            for (var i = 1; i < nbImgTmp; i++) {

                containerPositionString = "top:" + top + "px ; left:" + left + "px;"


                var divContainer = document.createElement("div");
                divContainer.setAttribute("id", "container_" + i);
                divContainer.setAttribute("class", "container");
                divContainer.setAttribute("style", containerPositionString + containerSizeString);


                var divToggle = document.createElement("div");
                divToggle.setAttribute("id", "toggle_" + i);
                divToggle.setAttribute("class", "toggle");
                divToggle.setAttribute("style", containerSizeString);

                divToggle.addEventListener('click', event => {
                    userPlaying(event);
                })
                var img = document.createElement("img");
                img.setAttribute("src", getRandomImgSrc());

                divContainer.appendChild(divToggle);
                divContainer.appendChild(img);

                $('div#table').append(divContainer);

                left += imgWidth + imgSpacing;
                if (i % nbCols == 0) {
                    top += imgHeight + imgSpacing;
                    left = 0;
                }
            }
        }

        function resetTry() {
            console.log('RESET');
            tabCompareImgSrc = [];
            tabToggleDivId = [];
            clickCount = 0;
            clearTimeout(resetTimeout);
        }


        function userPlaying(event) {
            if (isStartTimer) {
                startTimer();
                console.log('startTimer');
                isStartTimer = !isStartTimer;
            }

            // alert("element : " + event.target.parentElement.lastChild.src);



            if (tabCompareImgSrc.length < 2) {
                console.log('inferieur ' + tabCompareImgSrc.length);

                if (event.target.id) {
                    var toggleId = '#' + event.target.id;

                    //eviter le double clique sur le meme element
                    if (tabToggleDivId[0] == toggleId) {
                        return;
                    }
                    tabCompareImgSrc[clickCount] = event.target.parentElement.lastChild.src;
                    tabToggleDivId[clickCount] = toggleId;
                    console.log('inferieur 2' + tabCompareImgSrc.length);
                    clickCount++;
                    $(toggleId).animate({
                        height: '0px',
                        opacity: 0.3
                    }, 1000);

                    if (tabCompareImgSrc.length == 2) {

                        if (tabCompareImgSrc[0] == tabCompareImgSrc[1]) {

                            nbImgFound += 2;
                            if (nbImgFound == nbImg) {
                                nbImgFound = 0;
                                startGame();
                                return;
                            }

                            resetTimeout = setTimeout(() => {
                                resetTry();
                            }, 2500);

                        } else {
                            for (var t = 0; t != 2; t++) {
                                console.log('fermeture ' + tabToggleDivId[t]);
                                $(tabToggleDivId[t]).animate({
                                    height: imgHeight + 'px',
                                    opacity: 1
                                }, 800);
                                setTimeout(() => {
                                    resetTry();
                                }, 2500);
                            }

                        }


                    }
                }
            }
        }

        function startTimer() {

            const departMinutes = 0
            let temps = departMinutes * 60

            const timerElement = $('div#timer');

            setInterval(() => {
                $('div#timer').empty();
                let minutes = parseInt(temps / 60, 10)
                let secondes = parseInt(temps % 60, 10)

                minutes = minutes < 10 ? "0" + minutes : minutes
                secondes = secondes < 10 ? "0" + secondes : secondes

                var minuteNode = document.createElement('div');
                minuteNode.setAttribute('id', 'minutes')
                var textMinute = document.createTextNode(minutes);
                minuteNode.appendChild(textMinute);



                var secondNode = document.createElement('div');
                secondNode.setAttribute('id', 'seconds')
                var textSecond = document.createTextNode(secondes);
                minuteNode.appendChild(textSecond);

                $('div#timer').append(minuteNode);
                $('div#timer').append(secondNode);
                temps++;
            }, 1000)

        }





        function startGame() {
            resetTry();
            removeAllNode();
            initImgSize();
            initImgSrc();
            initImgPosition();
            displayImg();
        }


        function removeAllNode() {
            $('div#table').empty();
        }


        $(document).ready(function() {
            startGame();
        })
    </script>
</head>

<body>
    <img src="img/img1.jpg" id="imgSize">
    <div id="timer"></div>
    <div id="table"></div>



</body>

</html>